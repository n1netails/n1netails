<nz-layout class="app-layout">
  <nz-sider class="menu-sidebar" nzCollapsible nzCollapsed="true" [nzTrigger]="null">
    <app-sidenav></app-sidenav>
  </nz-sider>

  <nz-layout>
    <nz-header>
      <app-header></app-header>
    </nz-header>

    <nz-content>
      <div class="inner-content">
        <nz-row [nzGutter]="[16, 16]">
          <!-- N1ne Token Management Card -->
          <nz-col [nzXs]="24" [nzSm]="24" [nzMd]="24" [nzLg]="24" [nzXl]="24">
            <nz-card nzTitle="N1ne Token Manager" class="tails-primary-color main-card" [nzBordered]="false">
              <div *ngIf="isLoading" class="loading-indicator">Loading tokens...</div>
              <div *ngIf="errorMessage" class="error-message" style="color: red; margin-bottom: 10px;">{{ errorMessage }}</div>

              <!-- Create Token Form -->
              <h3>Create New Token</h3>
              <form #tokenForm="ngForm" (ngSubmit)="createToken()" nz-form>
                <nz-form-item>
                  <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="6" nzFor="tokenName" nzRequired>Token Name</nz-form-label>
                  <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="14">
                    <input nz-input type="text" id="tokenName" name="name" [(ngModel)]="newTokenRequestForm.name" placeholder="Enter a name for the token" required #name="ngModel">
                    <div *ngIf="name.invalid && (name.dirty || name.touched)" class="error-text">
                      Token name is required.
                    </div>
                  </nz-form-control>
                </nz-form-item>
                <nz-form-item>
                  <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="6" nzFor="organization" nzRequired>Organization</nz-form-label>
                  <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="14">
                    <nz-select
                      id="organization"
                      name="organization"
                      [(ngModel)]="newTokenRequestForm.organizationId"
                      nzPlaceHolder="Select organization"
                      required
                    >
                      <nz-option
                        *ngFor="let org of organizations"
                        [nzValue]="org.id"
                        [nzLabel]="org.name"
                      ></nz-option>
                    </nz-select>
                  </nz-form-control>
                </nz-form-item>
                <nz-form-item>
                  <nz-form-label [nzXs]="24" [nzSm]="24" [nzMd]="6" nzFor="tokenExpiresAt">Expiration Date (Optional)</nz-form-label>
                  <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="14">
                    <input nz-input type="datetime-local" id="tokenExpiresAt" name="expiresAt" [(ngModel)]="newTokenRequestForm.expiresAt">
                  </nz-form-control>
                </nz-form-item>
                <nz-form-item>
                  <nz-form-control [nzXs]="24" [nzSm]="24" [nzMd]="14" [nzMdOffset]="6">
                    <button nz-button nzType="primary" type="submit" [disabled]="!tokenForm.form.valid || isLoading" class="form-button">+ Create Token</button>
                  </nz-form-control>
                </nz-form-item>
              </form>

              <nz-divider></nz-divider>

              <!-- Display Tokens Table -->
              <h3>Active Tokens</h3>
              <div class="table-responsive">
                <nz-table #activeTokensTable [nzData]="tokens" [nzLoading]="isLoading" nzSize="small" [nzScroll]="{ x: '1000px' }">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>ID</th>
                      <th>Token Value</th>
                      <th>Created At</th>
                      <th>Expires At</th>
                      <th>Last Used At</th>
                      <th>Status</th>
                      <th>User</th>
                      <th>Org</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let token of tokens; let i = index">
                      <td>{{ token.name }}</td>
                      <td>{{ token.id }}</td>
                      <td>
                        <div class="token-value-cell">
                          <input
                            nz-input
                            [type]="showTokenIndex === i ? 'text' : 'password'"
                            [value]="token.token"
                            readonly
                            class="token-input"
                            (click)="toggleShowToken(i)"
                          />
                          <button
                            nz-button
                            nzType="link"
                            nzSize="small"
                            (click)="toggleShowToken(i)"
                            [attr.aria-label]="showTokenIndex === i ? 'Hide' : 'Show'"
                            class="action-icon"
                          >
                            <span *ngIf="showTokenIndex !== i" nz-icon nzType="eye-invisible"></span>
                            <span *ngIf="showTokenIndex === i" nz-icon nzType="eye"></span>
                          </button>
                          <button
                            nz-button
                            nzType="link"
                            nzSize="small"
                            (click)="copyToken(token.token)"
                            aria-label="Copy"
                            class="action-icon"
                          >
                            <span nz-icon nzType="copy"></span>
                          </button>
                        </div>
                      </td>
                      <td>{{ token.createdAt | date:'short' }}</td>
                      <td>{{ token.expiresAt ? (token.expiresAt | date:'short') : 'Never' }}</td>
                      <td>{{ token.lastUsedAt ? (token.lastUsedAt | date:'short') : 'Never' }}</td>
                      <td>
                        <span *ngIf="token.revoked" class="status-revoked">Revoked</span>
                        <span *ngIf="!token.revoked" class="status-active">Active</span>
                      </td>
                      <td>{{ user.username }}</td>
                      <!-- TODO GET ORGANIATION INFO BY ORGANIZATION ID (DISPLAY ORGANIZATON NAME HERE)-->
                      <td>{{ token.organizationId }}</td>
                      <td>
                        <div class="action-buttons">
                          <button nz-button nzType="default" (click)="revokeToken(token)" *ngIf="!token.revoked" [disabled]="isLoading" nzSize="small" class="action-button">Revoke</button>
                          <button nz-button nzType="default" (click)="enableToken(token)" *ngIf="token.revoked" [disabled]="isLoading" nzSize="small" class="action-button">Enable</button>
                          <button nz-button nzType="primary" nzDanger (click)="deleteToken(token.id)" [disabled]="isLoading" nzSize="small" class="action-button">Delete</button>
                        </div>
                      </td>
                    </tr>
                    <tr *ngIf="!isLoading && tokens.length === 0">
                      <td colspan="10" style="text-align: center;">No tokens found.</td>
                    </tr>
                  </tbody>
                </nz-table>
              </div>
            </nz-card>
          </nz-col>
        </nz-row>

        <!-- TODO ADD THIS FEATURE IN LATER -->
        <!-- provide users with options to selete their perferred alert types -->
        <!-- <nz-row [nzGutter]="[16, 16]">
          <nz-col [nzXs]="24" [nzSm]="24" [nzMd]="24" [nzLg]="24" [nzXl]="24">
            <nz-card nzTitle="Preferred Alert Types" class="tails-primary-color" [nzBordered]="false">
              <form nz-form (ngSubmit)="onSavePreferredTypes()" #preferredTypesForm="ngForm">
                <nz-checkbox-group [(ngModel)]="preferredAlertTypes" [nzOptions]="alertTypeOptions"
                  name="preferredAlertTypes"></nz-checkbox-group>
                <button nz-button nzType="primary" type="submit" style="margin-top: 16px;">Save Preferences</button>
              </form>
            </nz-card>
          </nz-col>
        </nz-row> -->

        <nz-row [nzGutter]="[16, 16]">
          <nz-col [nzXs]="24" [nzSm]="24" [nzMd]="24" [nzLg]="24" [nzXl]="24">
            <nz-card nzTitle="Alert Levels, Statuses, and Types" class="tails-primary-color main-card" [nzBordered]="false">
              <nz-row [nzGutter]="[16,16]" class="alert-management-row">
                <nz-col [nzXs]="24" [nzSm]="24" [nzMd]="8">
                  <div class="alert-list">
                    <h4>Tail Levels</h4>
                    <ul>
                      <li *ngFor="let level of tailLevels">
                        <span>{{ level.name }}</span>
                        <button *ngIf="level.deletable" nz-button nzType="link" nzDanger (click)="removeAlertLevel(level.name)" class="remove-button">Remove</button>
                      </li>
                    </ul>
                    <div class="add-item-form">
                      <input nz-input [(ngModel)]="newTailLevel" name="newTailLevel" placeholder="Add new level" />
                      <button nz-button nzType="default" (click)="addAlertLevel()" class="add-button">+</button>
                    </div>
                  </div>
                </nz-col>
                <nz-col [nzXs]="24" [nzSm]="24" [nzMd]="8">
                  <div class="alert-list">
                    <h4>Tail Statuses</h4>
                    <ul>
                      <li *ngFor="let status of tailStatuses">
                        <span>{{ status.name }}</span>
                        <button *ngIf="status.deletable" nz-button nzType="link" nzDanger (click)="removeAlertStatus(status.name)" class="remove-button">Remove</button>
                      </li>
                    </ul>
                    <div class="add-item-form">
                      <input nz-input [(ngModel)]="newTailStatus" name="newTailStatus" placeholder="Add new status" />
                      <button nz-button nzType="default" (click)="addAlertStatus()" class="add-button">+</button>
                    </div>
                  </div>
                </nz-col>
                <nz-col [nzXs]="24" [nzSm]="24" [nzMd]="8">
                  <div class="alert-list">
                    <h4>Tail Types</h4>
                    <ul>
                      <li *ngFor="let type of tailTypes">
                        <span>{{ type.name }}</span>
                        <button *ngIf="type.deletable" nz-button nzType="link" nzDanger (click)="removeAlertType(type.name)" class="remove-button">Remove</button>
                      </li>
                    </ul>
                    <div class="add-item-form">
                      <input nz-input [(ngModel)]="newTailType" name="newTailType" placeholder="Add new type" />
                      <button nz-button nzType="default" (click)="addAlertType()" class="add-button">+</button>
                    </div>
                  </div>
                </nz-col>
              </nz-row>
            </nz-card>
          </nz-col>
        </nz-row>
      </div>
    </nz-content>
  </nz-layout>
</nz-layout>